import*as THREE from"three";import{MathUtils}from"three";import{MagicLoader}from"../loaders.js";import{byId,createAppEvent,getAxisAndAngelFromQuaternion,htmlHeader}from"../utility.js";import"./rtc-multi-connection/FileBufferReader.js";import{getHTMLMediaElement}from"./rtc-multi-connection/getHTMLMediaElement.js";import*as RTCMultiConnection3 from"./rtc-multi-connection/RTCMultiConnection3.js";export class Broadcaster{constructor(e,t){this.scene=t,this.loader=new MagicLoader(e,t),this.injector,this.openOrJoinBtn,this.connection,this.engineConfig,this.popupUI=null,this.broadcasterUI=null,this.titleStatus=null,this.openRoomBtn=null,this.joinRoomBtn=null,this.leaveRoomBtn=null,this.shareFileBtn=null,this.inputChat=null,this.inputRoomId=null,this.openDataSession=()=>{},this.netPlayers={},this.multiPlayerRef={root:this,myBigDataFlag:[],init(e){console.log("rtcEvent add new net object -> ",e.userid),this.root.loader.fbx("./assets/objects/player/walk-forward-r.fbx","net_"+e.userid).then((t=>{console.info("[fbx] Setup player animation character obj =>",t.name),this.root.netPlayers["net_"+e.userid]=t,this.root.createNetPlayerCollisionBox(new THREE.Vector3(2,2,1),t.position,t.quaternion,App.materials.assets.basic,"net-collision-box"+e.userid,!1)}))},update(e){e.data.netPos&&("netPlayer"==e.data.netType&&void 0!==this.root.netPlayers["net_"+e.data.netObjId]&&(this.root.netPlayers["net_"+e.data.netObjId].position.set(e.data.netPos.x,e.data.netPos.y-1,e.data.netPos.z),this.root.netPlayers["net_"+e.data.netObjId].rotation.y=e.data.netRot.y),"netEnvObj"==e.data.netType&&this.root.scene.getObjectByName(e.data.netObjId).userData.physicsBody.setLinearVelocity(new Ammo.btVector3(e.data.netPos.x,e.data.netPos.y,e.data.netPos.z)))},leaveGamePlay(e){let t=this.root.netPlayers["net_"+e.userid];console.info("rtcEvent LEAVE GAME: ",e.userid),console.info("rtcEvent LEAVE GAME: ",this.root.scene.remove(t)),delete this.root.netPlayers["net_"+e.userid],console.info("rtcEvent LEAVE GAME is undefined: ",this.root.netPlayers["net_"+e.userid])}},this.engineConfig=e.networking,1==this.engineConfig.broadcasterInit&&this.runBroadcaster()}closeAllPeers(){this.connection.close()}openRoomBtnVisible=e=>{!0===e?byId("open-room").classList.remove("hide"):byId("open-room").classList.add("hide")};activateDataStream(){this.injector=this.multiPlayerRef,setTimeout((()=>{this.openOrJoinBtn.click()}),1e3)}initDOM(){this.broadcasterUI=byId("matrix-net"),this.titleStatus=byId("rtc3log"),this.openRoomBtn=byId("open-room"),this.joinRoomBtn=byId("join-room"),this.openOrJoinBtn=byId("open-or-join-room"),this.leaveRoomBtn=byId("btn-leave-room"),this.shareFileBtn=byId("share-file"),this.inputChat=byId("input-text-chat"),this.inputRoomId=byId("room-id"),this.openRoomBtnVisible(!0)}streamLoaded(e,t){const n=createAppEvent("stream-loaded",{streamId:t,userId:e});return window.dispatchEvent(n),t}initWebRtc=e=>{const t=this;try{this.connection=new RTCMultiConnection3}catch(e){this.connection=new RTCMultiConnection3.default}this.connection.socketURL=t.engineConfig.getBroadcastSockRoute(),this.connection.socketMessageEvent="audio-video-file-chat-demo",void 0!==e?(this.connection.enableFileSharing=e.enableFileSharing,this.connection.session={audio:e.session.audio,video:e.session.video,data:e.session.data}):(this.connection.enableFileSharing=t.engineConfig.broadcasterSessionDefaults.enableFileSharing,this.connection.session={audio:t.engineConfig.broadcasterSessionDefaults.sessionAudio,video:t.engineConfig.broadcasterSessionDefaults.sessionVideo,data:t.engineConfig.broadcasterSessionDefaults.sessionData}),this.connection.sdpConstraints.mandatory={OfferToReceiveAudio:!0,OfferToReceiveVideo:!1},this.connection.iceServers=[{urls:t.engineConfig.stunList}],this.connection.videosContainer=document.getElementById("videos-container"),this.connection.videosContainer.setAttribute("style","position:absolute;left:0;bottom:20%;width:320px;height:auto;"),this.connection.onstream=function(e){e.mediaElement.removeAttribute("src"),e.mediaElement.removeAttribute("srcObject");const n=document.createElement("video");n.controls=!0,"local"===e.type&&(n.muted=!0),n.srcObject=e.stream;const o=t.connection.videosContainer.clientWidth,i=parseInt(o.toString(),10),s=getHTMLMediaElement(n,{title:e.userid,buttons:["full-screen"],width:i,showOnMouseEnter:!1});t.connection.videosContainer.appendChild(s),setTimeout((function(){s.media.play()}),2e3),s.id=e.streamid,t.streamLoaded(e.userid,e.streamid)},this.connection.onstreamended=function(e){const t=document.getElementById(e.streamid);t&&t.parentNode.removeChild(t)},this.connection.onmessage=t.appendDIV,this.connection.filesContainer=document.getElementById("file-container"),this.connection.onopen=function(e){t.shareFileBtn.disabled=!1,t.inputChat.disabled=!1,t.leaveRoomBtn.disabled=!1,t.injector&&t.injector.init(e),console.info("You are connected with: "+t.connection.getAllParticipants().join(", ")),document.querySelector("#rtc3log").innerHTML="You are connected with: "+t.connection.getAllParticipants().join(", ")},this.connection.onclose=function(e){t.injector.leaveGamePlay(e),t.connection.getAllParticipants().length?document.querySelector("#rtc3log").value="You are still connected with:"+t.connection.getAllParticipants().join(", "):document.querySelector("#rtc3log").value="Seems session has been closed or all participants left."},this.connection.onUserStatusChanged=function(e){"offline"===e.status&&t.injector.leaveGamePlay(e)},this.connection.onEntireSessionClosed=function(e){t.shareFileBtn.disabled=!0,t.inputChat.disabled=!0,t.leaveRoomBtn.disabled=!0,t.openOrJoinBtn.disabled=!1,t.openRoomBtn.disabled=!1,t.inputRoomId.disabled=!1,t.inputRoomId.disabled=!1,t.connection.attachStreams.forEach((function(e){e.stop()})),t.connection.userid!==e.userid&&(document.querySelector("#rtc3log").innerHTML="Entire session has been closed by the moderator: "+e.userid)},this.connection.onUserIdAlreadyTaken=function(e){t.connection.join(e)},this.postAttach()};showRoomURL(e){console.info("Entering in room: ",e)}disableInputButtons=()=>{this.openOrJoinBtn.disabled=!0,this.openRoomBtn.disabled=!0,this.inputRoomId.disabled=!0,this.inputRoomId.disabled=!0,this.leaveRoomBtn.disabled=!1};appendDIV=e=>{if(e.data&&(e.data.netPos||e.data.netRot||e.data.netScale||e.data.spitz||e.data.texScaleFactor))return void this.injector.update(e);const t=document.createElement("div");t.innerHTML=e.data||e,t.setAttribute("style","width:90%;color:white;");const n=document.querySelector(".chat-output");n.insertBefore(t,n.firstChild),t.tabIndex=0,t.focus(),document.getElementById("input-text-chat").focus()};postAttach(){const e=this;var t="";t=localStorage.getItem(e.connection.socketMessageEvent)?localStorage.getItem(e.connection.socketMessageEvent):e.connection.token(),e.engineConfig.masterServerKey&&(t=e.engineConfig.masterServerKey),e.inputRoomId.value=t,e.inputRoomId.onkeyup=function(){localStorage.setItem(e.connection.socketMessageEvent,this.value)};let n=location.hash.replace("#","");n.length&&0===n.indexOf("comment-")&&(n=""),!(t=window.params.roomid)&&n.length&&(t=n),t&&t.length&&(e.inputRoomId.value=t,localStorage.setItem(e.connection.socketMessageEvent,t),function n(){e.connection.checkPresence(t,(function(o){o?e.connection.join(t):setTimeout(n,5e3)}))}(),e.disableInputButtons())}attachEvents(){const e=this;window.enableAdapter=!0,e.broadcasterUI.classList.remove("network-panel-show-ver-animation"),e.broadcasterUI.classList.add("network-panel-hide-ver-animation"),e.titleStatus.onclick=function(){e.broadcasterUI.classList.contains("network-panel-show-ver-animation")?(e.broadcasterUI.classList.remove("network-panel-show-ver-animation"),e.broadcasterUI.classList.add("network-panel-hide-ver-animation")):(e.broadcasterUI.classList.add("network-panel-show-ver-animation"),e.broadcasterUI.classList.remove("network-panel-ver-hide-animation"))},e.openRoomBtn.onclick=function(){e.disableInputButtons(),e.connection.open(e.inputRoomId.value,(function(){e.showRoomURL(e.connection.sessionid)}))},e.joinRoomBtn.onclick=function(){e.disableInputButtons(),e.connection.join(e.inputRoomId.value)},e.openDataSession=function(){e.disableInputButtons(),e.connection.openOrJoin(e.inputRoomId.value,(function(t,n){t||e.showRoomURL(n)}))},e.openOrJoinBtn.onclick=e.openDataSession,e.leaveRoomBtn.onclick=function(){this.disabled=!0,e.connection.isInitiator?e.connection.closeEntireSession((function(){document.querySelector("#rtc3log").innerHTML="Entire session has been closed."})):e.connection.leave()},e.shareFileBtn.onclick=function(){(new window.FileSelector).selectSingleFile((function(t){e.connection.send(t)}))},e.inputChat.onkeyup=function(t){13==t.keyCode&&(this.value=this.value.replace(/^\s+|\s+$/g,""),this.value.length&&(e.connection.send(this.value),e.appendDIV(this.value),this.value=""))},function(){const e={},t=/([^&=]+)=?([^&]*)/g;function n(e){return decodeURIComponent(e.replace(/\+/g," "))}let o,i=window.location.search;for(;o=t.exec(i.substring(1));)e[n(o[1])]=n(o[2]);window.params=e}()}runBroadcaster=()=>{const e=this;fetch("./broadcaster.html",{headers:htmlHeader}).then((function(e){return e.text()})).then((function(t){e.popupUI=byId("matrix-net"),e.popupUI.style="table",e.popupUI.innerHTML=t,1==e.engineConfig.broadcasterInit?e.popupUI.style.display="table":e.popupUI.style.display="none",e.initDOM(),e.attachEvents(),e.initWebRtc(),e.inputRoomId.nodeValue=e.engineConfig.masterServerKey,e.engineConfig.broadcastAutoConnect&&(console.log("Try auto connect [broadcaster]."),e.injector=e.multiPlayerRef,e.openOrJoinBtn.click())}))}}
